
<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>Statistik – Vasketider</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="manifest" href="/static/manifest.json">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    /* Let, stabil styling til statistik-siderne */
    body { color: #fff; }
    .container { max-width: 1180px; margin: 90px auto 40px; padding: 0 16px; }
    .window { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.25); border-radius: 14px; padding: 18px; backdrop-filter: blur(6px); }
    .window h3 { margin-top: 0; font-size: 18px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 6px; margin-bottom: 10px; }
    .muted { font-size: 12px; opacity: .8; }
    .kpis, .grid-2, .grid-3 { display: grid; gap: 16px; }
    .kpis { grid-template-columns: repeat(4, minmax(0,1fr)); }
    .grid-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .kpi { padding: 12px; border: 1px solid rgba(255,255,255,.25); border-radius: 12px; background: rgba(255,255,255,.06); }
    .kpi .t { font-size: 12px; opacity: .85; }
    .kpi .v { font-size: 24px; font-weight: 700; margin-top: 4px; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th,td { padding:6px 8px; border-bottom:1px solid rgba(255,255,255,0.15); text-align:left; vertical-align: top; }
    .badge { display:inline-block; padding:8px 12px; border-radius:12px; background: rgba(76,175,80,0.2); border:1px solid rgba(76,175,80,0.5); font-weight:600; margin: 8px 0 0 0; }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 14px; }
    .tab-btn { border:1px solid rgba(255,255,255,0.25); background:rgba(255,255,255,0.10); color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer }
    .tab-btn.active { outline:2px solid rgba(106,160,255,.9) }
    .page { display:none }
    .page.active { display:block }

    /* Topbar */
    .toppanel { position: fixed; top: 0; left: 0; right: 0; display: flex; gap: 10px; padding: 10px 16px;
      background: rgba(0,0,0,.55); border-bottom: 1px solid rgba(255,255,255,.2); backdrop-filter: blur(6px); z-index: 1000; }
    .toppanel form { margin: 0; }
    .toppanel-knap { padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,.25); background: rgba(255,255,255,.10); color: #fff; cursor: pointer; }

    /* Mobilblok – mere konservativ så desktop ikke blokeres ved small viewport */
    .mobile-block { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); color: #fff; z-index: 2000; align-items: center; justify-content: center; text-align: center; padding: 24px; }
    @media (max-width: 820px) {
      .container { display: none !important; }
      .mobile-block { display: flex; }
      body { overflow: hidden; }
    }

    .danger { border-color: rgba(255,0,0,0.55) !important; background: rgba(255,0,0,0.08) !important; }
    canvas { width:100%; height: 280px; max-width: 100%; }

    /* ---- Prik/punkt-liste til Login-aktivitet ---- */
    .dotlist { list-style: disc; padding-left: 22px; margin: 8px 0; }
    .dotlist li {
      margin-bottom: 12px; padding: 8px 10px;
      border-radius: 8px; background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15);
    }
    .dotlist li[data-status="fejl"]   { border-color: rgba(255,0,0,0.40); background: rgba(255,0,0,0.08); }
    .dotlist li[data-status="succes"] { border-color: rgba(0,200,0,0.30); background: rgba(0,200,0,0.08); }

    .badge-ok   { display:inline-block; padding:2px 8px; border-radius:10px; border:1px solid rgba(0,200,0,.5); background: rgba(0,200,0,.1); font-weight:600; font-size:12px; }
    .badge-fail { display:inline-block; padding:2px 8px; border-radius:10px; border:1px solid rgba(255,0,0,.5); background: rgba(255,0,0,.1); font-weight:600; font-size:12px; }

    .kv { display:inline-block; margin-right:10px; }
    .kv b { opacity:.9; }
    details.ua { margin-top:6px; }
    details.ua summary { cursor:pointer; user-select:none; }
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/service-worker.js');
    }
  </script>
</head>
<body style="background: url('/static/Bg.jpg') no-repeat center center fixed; background-size: cover;">

  <!-- MOBIL-OVERLAY -->
  <div class="mobile-block">
    <div>
      <h2>📈 Statistik er kun til desktop</h2>
      <p>Åbn siden på en desktop computer for at se statistik-vinduerne.</p>
      <form method="get" action="/index" style="margin-top:16px;">
        <button class="toppanel-knap">Tilbage til kalender</button>
      </form>
    </div>
  </div>

  <!-- Top-panel -->
  <div class="toppanel">
    <form method="post" action="/logout"><button class="toppanel-knap">Log ud</button></form>
    <form method="get" action="/admin"><button class="toppanel-knap">Admin</button></form>
    <form method="get" action="/download_valg"><button class="toppanel-knap">Download PDF</button></form>
    <form method="get" action="/index" style="margin-left:auto;"><button class="toppanel-knap">Kalender</button></form>
  </div>

  <div class="container">
    <h2>Statistik</h2>
    {% if request.args.get("besked") %}
      <div class="badge">{{ request.args.get("besked") }}</div>
    {% endif %}

    <nav class="tabs" role="tablist" aria-label="Statistik faner">
      <button class="tab-btn active" data-tab="page1" role="tab" aria-selected="true">Side 1 · Overblik</button>
      <button class="tab-btn" data-tab="page2" role="tab" aria-selected="false">Side 2 · Brugsmønstre</button>
      <button class="tab-btn" data-tab="page3" role="tab" aria-selected="false">Side 3 · Sikkerhed & regler</button>
    </nav>

    <!-- ===================== SIDE 1 – OVERBLIK ===================== -->
    <section id="page1" class="page active" role="tabpanel" aria-labelledby="tab-page1">
      <div class="kpis">
        <div class="kpi"><div class="t">Aktive bookinger (næste 14 dage)</div><div class="v">{{ kpi.aktive_14|default(0) }}</div></div>
        <div class="kpi"><div class="t">Unikke brugere (næste 14 dage)</div><div class="v">{{ kpi.unikke_brugere|default(0) }}</div></div>
        <div class="kpi"><div class="t">Service-blokke (næste 14 dage)</div><div class="v">{{ kpi.service_blok|default(0) }}</div></div>
        <div class="kpi"><div class="t">Direktetid i alt</div><div class="v">{{ total_direkte|default(0) }}</div></div>
      </div>

      <div class="kpis" style="margin-top:12px;">
        <div class="kpi"><div class="t">Bookinger (30 dage)</div><div class="v">{{ kpi.bookinger_30d|default(0) }}</div></div>
        <div class="kpi"><div class="t">Ikke brugt (30 dage)</div><div class="v">{{ kpi.ikke_brugt_30d|default(0) }}</div></div>
        <div class="kpi"><div class="t">Udnyttelse (30 dage)</div><div class="v">{{ kpi.udnyttelse_30d_pct|default(0) }}%</div></div>
        <div class="kpi"><div class="t">Kæder (30 dage) – snit</div><div class="v">{{ kpi.kaeder_30d|default(0) }} / {{ kpi.kaede_avg_score|default(0) }}</div></div>
      </div>

      <div class="grid-2" style="margin-top:16px;">
        <div class="window">
          <h3>Direktetid pr. dag (sidste 30 dage)</h3>
          <div class="muted">Kilde: `statistik` (fallback: `bookinger` for brugernavn='direkte')</div>
          <div class="chart-wrap"><canvas id="chartDirekte"></canvas></div>
        </div>

        <div class="window">
          <h3>Ikke brugte bookinger</h3>
          <div class="muted">Seneste 30 auto_remove-hændelser</div>
          <table>
            <thead><tr><th>Dato</th><th>Slot</th><th>Brugernavn</th></tr></thead>
            <tbody>
              {% if ikke_bruge_tabel and ikke_bruge_tabel|length > 0 %}
                {% for r in ikke_bruge_tabel %}
                  <tr><td>{{ r.dato }}</td><td>{{ r.slot }}</td><td>{{ r.brugernavn }}</td></tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="3" class="muted">Ingen registrerede no-shows i vinduet.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="window" style="margin-top:16px;">
        <h3>Kæder (Direkte → Bruger)</h3>
        <table>
          <thead><tr><th>Dato</th><th>Direkte slot</th><th>Bruger slot</th><th>Bruger</th><th>Score</th><th>Note</th></tr></thead>
          <tbody>
            {% if kaeder and kaeder|length > 0 %}
              {% for k in kaeder %}
                <tr>
                  <td>{{ k[0] }}</td>
                  <td>{{ k[1] }}</td>
                  <td>{{ k[2] }}</td>
                  <td>{{ k[3] }}</td>
                  <td>{{ k[4] }}</td>
                  <td>{{ k[5] }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="6" class="muted">Ingen kæder i perioden.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- ===================== SIDE 2 – BRUGSMØNSTRE ===================== -->
    <section id="page2" class="page" role="tabpanel" aria-labelledby="tab-page2">
      <div class="grid-2">
        <div class="window">
          <h3>Udnyttelse pr. slot (30 dage)</h3>
          <table>
            <thead><tr><th>Slot</th><th>Brugte</th><th>Ikke brugt</th><th>Udnyttelse</th></tr></thead>
            <tbody>
              {% if slot_overblik and slot_overblik|length > 0 %}
                {% for r in slot_overblik %}
                  <tr>
                    <td>{{ r.slot }}</td>
                    <td>{{ r.brugte }}</td>
                    <td>{{ r.ikke_brugt }}</td>
                    <td>{{ r.udnyttelse_pct }}%</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="4" class="muted">Ingen data.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>

        <div class="window">
          <h3>Udnyttelse pr. ugedag (30 dage)</h3>
          <table>
            <thead><tr><th>Dag</th><th>Brugte</th><th>Ikke brugt</th><th>Udnyttelse</th></tr></thead>
            <tbody>
              {% if weekday_overblik and weekday_overblik|length > 0 %}
                {% for r in weekday_overblik %}
                  <tr>
                    <td>{{ r.dag }}</td>
                    <td>{{ r.brugte }}</td>
                    <td>{{ r.ikke_brugt }}</td>
                    <td>{{ r.udnyttelse_pct }}%</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="4" class="muted">Ingen data.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="window" style="margin-top:16px;">
        <h3>Bruger-mønstre (Top 15 no-show-rate)</h3>
        <table>
          <thead><tr><th>Bruger</th><th>Bookinger</th><th>Ikke brugt</th><th>No-show rate</th></tr></thead>
          <tbody>
            {% if bruger_moenstre and bruger_moenstre|length > 0 %}
              {% for r in bruger_moenstre %}
                <tr>
                  <td>{{ r.brugernavn }}</td>
                  <td>{{ r.bookinger }}</td>
                  <td>{{ r.ikke_brugt }}</td>
                  <td>{{ r.ikke_brugt_rate }}%</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="4" class="muted">Ingen data.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- ===================== SIDE 3 – SIKKERHED & REGLER ===================== -->
    <section id="page3" class="page" role="tabpanel" aria-labelledby="tab-page3">
      <div class="grid-3">
        <div class="kpi"><div class="t">Miele status</div><div class="v">{{ miele_status|default('Ukendt') }}</div></div>
        <div class="kpi"><div class="t">Miele opdateret</div><div class="v">{{ miele_opdateret|default('—') }}</div></div>
        <div class="kpi"><div class="t">Miele log-rækker</div><div class="v">{{ miele_logs|default(0) }}</div></div>
      </div>

      <div class="grid-2" style="margin-top:16px;">
        <div class="window login-window">
  <h3>Login-aktivitet (30 dage)</h3>
  <div class="muted">OK/afvist, IP, device, UA og (hvis tilgængeligt) geo/ASN</div>

<div class="login-scroll">
  <ul id="loginList" class="dotlist" role="list">
    {% if logins and logins|length > 0 %}
      {% for r in logins %}
        <li class="login-item" data-status="{{ 'succes' if r.indikator_ok else 'fejl' }}">
          <div class="row">
            <span class="k"><b>Tid</b></span><span class="v">{{ r.tidspunkt }}</span>
            <span class="k"><b>Bruger</b></span><span class="v">{{ r.brugernavn }}</span>
            <span class="k"><b>Status</b></span>
            <span class="v">
              {% if r.indikator_ok %}<span class="badge-ok">OK</span>{% else %}<span class="badge-fail">Afvist</span>{% endif %}
              {% if r.ip_is_datacenter %}<span class="badge-fail" title="Datacenter/bot?">DC</span>{% endif %}
            </span>

            <span class="k"><b>Browser/OS</b></span><span class="v">{{ r.ua_browser }} / {{ r.ua_os }}</span>
            <span class="k"><b>Enhed</b></span><span class="v">{{ r.ua_device }}</span>

            <span class="k"><b>IP</b></span><span class="v">{{ r.ip or '—' }}{% if r.ip_hash %} <span class="muted">(hash: {{ r.ip_hash[:10] }}…)</span>{% endif %}</span>

            {% if r.ip_city or r.ip_region or r.ip_country or r.ip_org %}
              <span class="k"><b>Geo/ASN</b></span>
              <span class="v">
                {{ r.ip_city }}{% if r.ip_city and (r.ip_region or r.ip_country) %}, {% endif %}
                {{ r.ip_region }}{% if r.ip_region and r.ip_country %}, {% endif %}
                {{ r.ip_country }}{% if r.ip_org %} — {{ r.ip_org }}{% endif %}
              </span>
            {% endif %}
          </div>

          <details class="ua"><summary>Vis fuld User-Agent</summary>
            <div class="muted">{{ r.enhed or '—' }}</div>
          </details>
        </li>
      {% endfor %}
    {% else %}
      <li class="muted">Ingen login-aktivitet i perioden.</li>
    {% endif %}
  </ul>
</div>
</div>

        <div class="window">
          <h3>Bookingforsøg pr. dag (30 dage)</h3>
          <table>
            <thead><tr><th>Dato</th><th>Bruger</th><th>Forsøg</th></tr></thead>
            <tbody>
              {% if attempts_by_user_day and attempts_by_user_day|length > 0 %}
                {% for r in attempts_by_user_day %}
                  <tr><td>{{ r.dato }}</td><td>{{ r.brugernavn }}</td><td>{{ r.forsøg }}</td></tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="3" class="muted">Ingen registrerede forsøg.</td></tr>
              {% endif %}
            </tbody>
          </table>

          <h3 style="margin-top:14px;">Brugere over 2 forsøg/dag (30 dage)</h3>
          <table>
            <thead><tr><th>Dato</th><th>Bruger</th><th>Forsøg</th></tr></thead>
            <tbody>
              {% if attempts_over_2 and attempts_over_2|length > 0 %}
                {% for r in attempts_over_2 %}
                  <tr><td>{{ r.dato }}</td><td>{{ r.brugernavn }}</td><td>{{ r.forsøg }}</td></tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="3" class="muted">Ingen over 2/dag i perioden.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Danger Zone (ryd logninger) – virker sammen med /admin/ryd_logs i app.py -->
      <div class="window danger" style="margin-top:16px;">
        <h3>⚠️ Ryd logninger (Danger Zone)</h3>
        <form method="post" action="/admin/ryd_logs" onsubmit="return confirm('Er du sikker? Dette kan ikke fortrydes.');">
  <div class="grid-2">
    <div>
      <label><input type="checkbox" name="slet_login" value="1"> Slet <strong>login_log</strong></label>
      <label><input type="checkbox" name="slet_booking" value="1"> Slet <strong>booking_log</strong></label>
      <label><input type="checkbox" name="slet_attempts" value="1"> Slet <strong>booking_attempts</strong></label>
      <label><input type="checkbox" name="slet_kaeder" value="1"> Slet <strong>direkte_kæder</strong></label>
    </div>
    <div>
      <label><input type="checkbox" name="slet_miele_act" value="1"> Slet <strong>miele_activity</strong></label>
      <label><input type="checkbox" name="slet_miele_stat" value="1"> Slet <strong>miele_status</strong></label>
      <label><input type="checkbox" name="slet_statistik" value="1"> Slet <strong>statistik</strong></label>
      <label style="margin-top:8px;"><input type="checkbox" name="slet_alt" value="1"> <strong>TRUNCATE ALT</strong></label>
    </div>
  </div>
          <div style="margin-top:12px;">
            <div class="muted">Valgfrit dato-interval:</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">
              <div><label>Fra dato</label><br><input type="date" name="fra_dato"></div>
              <div><label>Til dato</label><br><input type="date" name="til_dato"></div>
            </div>
          </div>

          <div style="margin-top:14px;">
            <button class="toppanel-knap" type="submit" style="background:rgba(220,0,0,.85);color:#fff;border:1px solid rgba(255,255,255,.25);">Slet valgte logninger</button>
          </div>
        </form>
      </div>
    </section>
  </div>

  <footer>© Hornsberg Group</footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Tabs
    const tabs = document.querySelectorAll('.tab-btn');
    const pages = document.querySelectorAll('.page');
    tabs.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        tabs.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const id = btn.dataset.tab;
        pages.forEach(p=>p.classList.toggle('active', p.id===id));
      });
    });

    // Chart: direkte pr. dag (serveren giver "direkte_pr_dag" som liste af [dato, antal])
    (function(){
      const el = document.getElementById('chartDirekte');
      if(!el) return;
      const labels = {{ direkte_pr_dag|map(attribute=0)|list|tojson }};
      const dataVals = {{ direkte_pr_dag|map(attribute=1)|list|tojson }};
      new Chart(el.getContext('2d'), {
        type: 'line',
        data: {
          labels: labels.reverse(),
          datasets: [{
            label: 'Direktetid',
            data: dataVals.reverse(),
            tension: 0.2,
            fill: false
          }]
        },
        options: {
          plugins: { legend: { display: true }},
          scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 10 } } }
        }
      });
    })();
  </script>
</body>
</html>