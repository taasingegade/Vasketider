<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>Vasketider</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=fix1">

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('{{ url_for("static", filename="service-worker.js") }}');
    }
  </script>
</head>
<body>

  <!-- TOP -->
<header class="toppanel" role="banner">
  <div class="top-left">
    <button class="hamburger" id="indexHamburger" type="button"
            aria-controls="indexTopMenu" aria-expanded="false">
      <span class="hamburger-bar"></span>
      <span class="hamburger-bar"></span>
      <span class="hamburger-bar"></span>
    </button>

    <!-- Dropdown menu -->
    <nav id="indexTopMenu" class="topmenu" aria-hidden="true" role="menu">
      <form method="get" action="/kommentar"><button class="toppanel-knap" type="submit">Kommentar</button></form>
      <form method="get" action="/dokumenter"><button class="toppanel-knap" type="submit">Dokumenter</button></form>
      <form method="get" action="/profil"><button class="toppanel-knap" type="submit">Min profil</button></form>
      <form method="get" action="/regler"><button class="toppanel-knap" type="submit">Regler</button></form>
      <form method="post" action="/logout"><button class="toppanel-knap danger" type="submit">Log ud</button></form>
    </nav>
 </div>
 
  <!-- STATUS: bliver stÃ¥ende i midten -->
  <div class="status status-center" id="miele-status" data-remaining="{{ miele_remaining or 0 }}">
    <span class="status-label">ðŸ§º Status:</span>
    <span class="status-value">{{ (miele_status or 'ukendt')|capitalize }}</span>
    <span class="status-sep">â€¢</span>
    <span class="status-eta" id="status-eta" style="display:none;"></span>
  </div>

  <!-- UGE-VISNING: oppe i hÃ¸jre side -->
  <div class="top-right">
    <form method="get" action="/index" class="week-switch" aria-label="UgevÃ¦lger">
      <button class="toppanel-knap" type="submit" name="uge" value="{{ valgt_uge - 1 }}">â—€</button>
      <span class="week-label">{{valgt_uge}}</span>
      <button class="toppanel-knap" type="submit" name="uge" value="{{ valgt_uge + 1 }}">â–¶</button>
    </form>
  </div>
</header>

  <!-- INDHOLD -->
  <main class="wrapper" role="main">
    <div class="main">
      <h2 class="page-title">Vasketider for TÃ¥singegade 16 â€“ Uge {{ valgt_uge }}</h2>

      {% if request.args.get("besked") %}
        <div id="popup-besked" class="popup-ok">
          {{ request.args.get("besked") }}
        </div>
      {% endif %}

      {% if request.args.get("fejl") %}
        <div id="popup-fejl" class="popup-error">
          {{ request.args.get("fejl") }}
        </div>
      {% endif %}

      <div class="calendar">
        <div></div>

        {% for dag in ugedage_dk %}
          {% set dhead = ugedage_dato[loop.index0] %}
          <div class="cal-head">
            <span class="cal-head-dag"><strong>{{ dag }}</strong></span>
            <span class="cal-head-dato">d. {{ dhead.day }}/{{ dhead.month }}</span>
          </div>
        {% endfor %}

        {% for i in range(4) %}
          <div class="time-label"><strong>{{ tider[i] }}</strong></div>

          {% for j in range(7) %}
            {% set dato = ugedage_dato[j] %}
            {% set cell = bookinger.get((dato, i)) %}

            <div class="cell-inner">
              {% if cell and cell.full %}
                {% set f = cell.full %}
                {% if f and f.navn == 'service' %}
                  <button class="slot-btn service" disabled>Service</button>
                {% elif f and f.navn == bruger %}
                  <form method="POST" action="/slet">
                    <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                    <input type="hidden" name="tid" value="{{ i }}">
                    <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                    <button type="submit" class="slot-btn optaget">{{ f.navn }}</button>
                  </form>
                {% else %}
                  <button class="slot-btn optaget" disabled>{{ f.navn }}</button>
                {% endif %}
              {% else %}
                {% set has_early = cell and (cell.early is not none) %}
                {% set has_late  = cell and (cell.late  is not none) %}

                {% if not (has_early and has_late) %}
                  <details class="split-details {% if (cell and cell.early and cell.early.navn=='service') or (cell and cell.late and cell.late.navn=='service') %}service{% else %}ledig{% endif %}">
                    <summary>Ledig</summary>
                    <div class="split-panel">
                      {% set fuld_disabled = has_early and has_late %}
                      <form method="POST" action="/book">
                        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                        <input type="hidden" name="tid" value="{{ i }}">
                        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                        <button type="submit" class="menu-btn" {% if fuld_disabled %}disabled{% endif %}>Book fuld</button>
                      </form>

                      <hr class="menu-sep">

                      <form method="POST" action="/book_half">
                        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                        <input type="hidden" name="tid" value="{{ i }}">
                        <input type="hidden" name="sub" value="early">
                        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                        <button type="submit" class="menu-btn" {% if has_early %}disabled{% endif %}>Del tid: tidlig</button>
                      </form>

                      <form method="POST" action="/book_half">
                        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                        <input type="hidden" name="tid" value="{{ i }}">
                        <input type="hidden" name="sub" value="late">
                        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                        <button type="submit" class="menu-btn" {% if has_late %}disabled{% endif %}>Del tid: sen</button>
                      </form>
                    </div>
                  </details>
                {% endif %}

                <div class="split-pair">
                  {% if has_early %}
                    {% set e = cell.early %}
                    {% if e and e.navn == 'service' %}
                      <button class="slot-btn service half" disabled>Service (tidlig)</button>
                    {% elif e and e.navn == bruger %}
                      <form method="POST" action="/slet">
                        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                        <input type="hidden" name="tid" value="{{ i }}">
                        <input type="hidden" name="sub" value="early">
                        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                        <button type="submit" class="slot-btn optaget half">Tidlig</button>
                      </form>
                    {% elif e %}
                      <button class="slot-btn optaget half" disabled>1 {{ e.navn }}</button>
                    {% endif %}
                  {% endif %}

                  {% if has_late %}
                    {% set l = cell.late %}
                    {% if l and l.navn == 'service' %}
                      <button class="slot-btn service half" disabled>Service (sen)</button>
                    {% elif l and l.navn == bruger %}
                      <form method="POST" action="/slet">
                        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                        <input type="hidden" name="tid" value="{{ i }}">
                        <input type="hidden" name="sub" value="late">
                        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                        <button type="submit" class="slot-btn optaget half">Senere</button>
                      </form>
                    {% elif l %}
                      <button class="slot-btn optaget half" disabled>2 {{ l.navn }}</button>
                    {% endif %}
                  {% endif %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        {% endfor %}
      </div>

      <hr class="section-div">

      <h3>Alle bookede tider (nÃ¦ste 14 dage):</h3>
      <ul id="bookinger_14_ul" class="bullet-list">
        {% if kommende_bookinger %}
          {% for b in kommende_bookinger %}
            <li><strong>{{ b.dato_dk }}</strong> â€“ <strong>{{ b.slot_tekst }}</strong> â†’ {{ b.brugernavn }}</li>
          {% endfor %}
        {% else %}
          <li>Ingen bookede tider de nÃ¦ste 14 dage.</li>
        {% endif %}
      </ul>
    </div>
  </main>

  <!-- FÃ†LLES menu-script: kun Ã©n attach -->
  <script>
  (function () {
    function attach(buttonSel, drawerSel) {
      const btn  = document.querySelector(buttonSel);
      const menu = document.querySelector(drawerSel);
      if (!btn || !menu) return;

      const setOpen = (open) => {
        btn.classList.toggle('active', open);
        menu.classList.toggle('show', open);
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
        menu.setAttribute('aria-hidden', open ? 'false' : 'true');
      };

      if (btn.dataset.bound === '1') return; // undgÃ¥ dobbelt-binding
      btn.dataset.bound = '1';

      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        setOpen(!menu.classList.contains('show'));
      }, { passive:true });

      document.addEventListener('click', (e) => {
        const inside = btn.contains(e.target) || menu.contains(e.target);
        if (!inside) setOpen(false);
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') setOpen(false);
      });

      setOpen(false);
    }

    function boot(){
      attach('#indexHamburger', '#indexTopMenu');
      // (login init er ikke nÃ¸dvendig pÃ¥ index-siden)
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', boot);
    } else {
      boot();
      setTimeout(boot, 50);
    }
  })();
  </script>

  <!-- Ã˜vrig side-JS (uÃ¦ndret) -->
  <script>
    function hentBookinger() {
      fetch('/bookinger_json')
        .then(res => { if (!res.ok) throw new Error("NetvÃ¦rksfejl: " + res.status); return res.json(); })
        .then(data => {
          const ul = document.getElementById('bookinger_14_ul');
          if (!ul) return;
          ul.innerHTML = "";
          if (data.length === 0) {
            ul.innerHTML = "<li>Ingen bookede tider de nÃ¦ste 14 dage.</li>";
          } else {
            data.forEach(function(item) {
              ul.innerHTML += `<li><strong>${item.dato}</strong> â€“ <strong>${item.tid}</strong> â†’ ${item.navn}</li>`;
            });
          }
        })
        .catch(error => { console.error("Fejl ved hentning af bookinger:", error); });
    }

    setInterval(hentBookinger, 10000);
    window.onload = function() {
      hentBookinger();
      const popupOK = document.getElementById('popup-besked');
      if (popupOK) setTimeout(() => { popupOK.style.display = 'none'; }, 3000);
      const popupErr = document.getElementById('popup-fejl');
      if (popupErr) setTimeout(() => { popupErr.style.display = 'none'; }, 4000);
      renderETA && renderETA();
      setInterval(() => tickETA && tickETA(), 60000);
    };
  </script>
<script>
/* === ETA i toppanelets statusbjÃ¦lke ===
   LÃ¦ser data-remaining (minutter) fra #miele-status,
   viser "FÃ¦rdig ca. kl. HH:MM (NN min)" og opdaterer hvert minut.
*/
(function(){
  const root = document.getElementById('miele-status');
  if (!root) return;

  const etaEl   = document.getElementById('status-eta');
  const statEl  = root.querySelector('.status-value');

  function getRemainingMin(){
    const raw = root.getAttribute('data-remaining');
    const n = parseInt(raw, 10);
    return Number.isFinite(n) ? Math.max(0, n) : 0;
  }

  function fmtHHMM(d){
    try { return d.toLocaleTimeString('da-DK', {hour:'2-digit', minute:'2-digit'}); }
    catch{ return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); }
  }

  function setVisible(show){
    if (!etaEl) return;
    etaEl.style.display = show ? '' : 'none';
  }

  let etaAtMs = null; // absolut sluttid i ms

  // Kaldt ved page load
  window.renderETA = function(){
    if (!etaEl) return;
    const remMin = getRemainingMin();

    // Vis kun hvis der er tid tilbage
    if (remMin <= 0) { setVisible(false); etaAtMs = null; return; }

    // SÃ¦t absolut ETA ud fra nuvÃ¦rende remaining
    etaAtMs = Date.now() + remMin * 60 * 1000;

    const eta = new Date(etaAtMs);
    etaEl.textContent = `FÃ¦rdig ca. kl. ${fmtHHMM(eta)} (${remMin} min)`;
    setVisible(true);
  };

  // Kaldt hvert minut
  window.tickETA = function(){
    if (!etaEl || etaAtMs === null) return;

    const diffMs = etaAtMs - Date.now();
    const remMin = Math.max(0, Math.round(diffMs / 60000));

    if (remMin <= 0){
      etaEl.textContent = 'Afslutter nu';
      // behold synlig et Ã¸jeblik â€” skjul hvis du vil:
      // setTimeout(()=>setVisible(false), 120000);
      return;
    }

    const eta = new Date(etaAtMs);
    etaEl.textContent = `FÃ¦rdig ca. kl. ${fmtHHMM(eta)} (${remMin} min)`;
    setVisible(true);
  };
})();
</script>
  <footer>Â© Hornsberg Group</footer>
</body>
</html>
