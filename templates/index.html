<!DOCTYPE html>
<html>
<head>
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
<title>Vasketider</title>
<link rel="manifest" href="/static/manifest.json">
<link rel="stylesheet" href="/static/style.css">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/static/service-worker.js');
  }
</script>
</head>
<body>
  <div class="toppanel">
    <form method="post" action="/logout">
      <button class="toppanel-knap">Log ud</button>
    </form>
    <form method="get" action="/kommentar">
      <button class="toppanel-knap">Kommentar</button>
    </form>
    <form method="get" action="/dokumenter">
      <button class="toppanel-knap">Dokumenter</button>
    </form>
    <form method="get" action="/profil">
      <button class="toppanel-knap">Min profil</button>
    </form>
    <form method="get" action="/regler">
      <button class="toppanel-knap">Regler</button>
    </form>
    <div class="status">
      <span class="status-label">ðŸ§º Status:</span>
      <span class="status-value">{{ miele_status | capitalize }}</span>
    </div>
    <form method="get" action="/index" style="margin-left:auto; display:flex; gap:10px;">
      <button class="toppanel-knap" type="submit" name="uge" value="{{ valgt_uge - 1 }}">â—€</button>
      <span style="color:white; align-self: center;">Uge {{ valgt_uge }}</span>
      <button class="toppanel-knap" type="submit" name="uge" value="{{ valgt_uge + 1 }}">â–¶</button>
    </form>
  </div>

  <div class="wrapper">
    <banner><h2>Vasketider for TÃ¥singegade 16 â€“ Uge {{ valgt_uge }}</h2></banner>

    <div class="main">
      {% if request.args.get("besked") %}
        <div id="popup-besked" style="position: relative; padding: 10px; background-color: rgba(0,150,0,0.7); color: white; border-radius: 8px; font-weight: bold; margin-top: 10px; max-width: 300px;">
          {{ request.args.get("besked") }}
        </div>
      {% endif %}

      {% if request.args.get("fejl") %}
        <div id="popup-fejl" style="position: relative; padding: 10px; background-color: rgba(200,0,0,0.8); color: white; border-radius: 8px; font-weight: bold; margin-top: 10px; max-width: 300px;">
          {{ request.args.get("fejl") }}
        </div>
      {% endif %}

      <div class="calendar">
        <div></div>
        {% for dag in ugedage_dk %}
          {% set dato = ugedage_dato[loop.index0] %}
          <div style="text-align:center;">
            <strong>{{ dag }}</strong><br>d. {{ dato.day }}/{{ dato.month }}
          </div>
        {% endfor %}

        {% for i in range(4) %}
          <div><strong>{{ tider[i] }}</strong></div>
          {% for j in range(7) %}
            {% set dato = ugedage_dato[j] %}
            {% set cell = bookinger.get((dato, i)) %}

<div style="display:flex;justify-content:center;align-items:center;gap:6px;flex-wrap:wrap;min-height:42px;">
  {% if cell and cell.full %}
    {# FULD BOOKING #}
    {% set f = cell.full %}
    {% if f.navn == "service" %}
      <button class="slot-btn service" disabled>Service</button>
    {% elif f.navn == bruger %}
      <form method="POST" action="/slet">
        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
        <input type="hidden" name="tid" value="{{ i }}">
        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
        <button type="submit" class="slot-btn" style="background-color:crimson;">
          {{ f.navn }} (fuld)
          {% if f.status == 'pending_activation' %} Â· venter aktivering{% endif %}
        </button>
      </form>
    {% else %}
      <button class="slot-btn" style="background-color:crimson;" disabled>
        {{ f.navn }}
        {% if f.status == 'pending_activation' %} Â· venter aktivering{% endif %}
      </button>
    {% endif %}

  {% else %}
    {# IKKE FULD â€“ halvdele #}
    {% set has_early = cell and (cell.early is not none) %}
    {% set has_late  = cell and (cell.late  is not none) %}

    {% if has_early or has_late %}
      {# EARLY #}
      {% if cell.early %}
        {% set e = cell.early %}
        {% if e.navn == "service" %}
          <button class="slot-btn service" disabled>Service (tidlig)</button>
        {% elif e.navn == bruger %}
          <form method="POST" action="/slet">
            <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
            <input type="hidden" name="tid" value="{{ i }}">
            <input type="hidden" name="sub" value="early">
            <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
            <button type="submit" class="slot-btn" style="background-color:crimson;">Tidlig (min)</button>
          </form>
        {% else %}
          <button class="slot-btn" style="background-color:crimson;" disabled>Tidlig ({{ e.navn }})</button>
        {% endif %}
      {% else %}
        <form method="POST" action="/book_half">
          <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
          <input type="hidden" name="tid" value="{{ i }}">
          <input type="hidden" name="sub" value="early">
          <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
          <button type="submit" class="slot-btn ledig-knap">Book tidlig</button>
        </form>
      {% endif %}

      {# LATE #}
      {% if cell.late %}
        {% set l = cell.late %}
        {% if l.navn == "service" %}
          <button class="slot-btn service" disabled>Service (sen)</button>
        {% elif l.navn == bruger %}
          <form method="POST" action="/slet">
            <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
            <input type="hidden" name="tid" value="{{ i }}">
            <input type="hidden" name="sub" value="late">
            <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
            <button type="submit" class="slot-btn" style="background-color:crimson;">Sen (min)</button>
          </form>
        {% else %}
          <button class="slot-btn" style="background-color:crimson;" disabled>Sen ({{ l.navn }})</button>
        {% endif %}
      {% else %}
        <form method="POST" action="/book_half">
          <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
          <input type="hidden" name="tid" value="{{ i }}">
          <input type="hidden" name="sub" value="late">
          <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
          <button type="submit" class="slot-btn ledig-knap">Book sen</button>
        </form>
      {% endif %}

    {% else %}
      {# HELT TOMT SLOT â†’ fuld + split start #}
      <form method="POST" action="/book">
        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
        <input type="hidden" name="tid" value="{{ i }}">
        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
        <button type="submit" class="slot-btn ledig-knap">Book fuld</button>
      </form>

      <form method="POST" action="/book_split">
        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
        <input type="hidden" name="tid" value="{{ i }}">
        <input type="hidden" name="del" value="early">
        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
        <button type="submit" class="slot-btn ledig-knap">Del tid: tidlig</button>
      </form>

      <form method="POST" action="/book_split">
        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
        <input type="hidden" name="tid" value="{{ i }}">
        <input type="hidden" name="del" value="late">
        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
        <button type="submit" class="slot-btn ledig-knap">Del tid: sen</button>
      </form>
    {% endif %}
  {% endif %}
</div>
          {% endfor %}
        {% endfor %}
      </div>

      <hr>
      <h3>Alle bookede tider (nÃ¦ste 14 dage):</h3>
      <ul>
        {% if kommende_bookinger %}
          {% for b in kommende_bookinger %}
            <li><strong>{{ b.dato_dk }}</strong> â€“ <strong>{{ b.slot_tekst }}</strong> â†’ {{ b.brugernavn }}</li>
          {% endfor %}
        {% else %}
          <li>Ingen bookede tider de nÃ¦ste 14 dage.</li>
        {% endif %}
      </ul>
    </div>
  </div>

<script>
function hentBookinger() {
  fetch('/bookinger_json')
    .then(res => { if (!res.ok) throw new Error("NetvÃ¦rksfejl: " + res.status); return res.json(); })
    .then(data => {
      let ul = document.getElementById('bookinger_14_ul');
      if (!ul) return;
      ul.innerHTML = "";
      if(data.length === 0) {
        ul.innerHTML = "<li>Ingen bookede tider de nÃ¦ste 14 dage.</li>";
      } else {
        data.forEach(function(item) {
          ul.innerHTML += `<li><strong>${item.dato}</strong> â€“ <strong>${item.tid}</strong> â†’ ${item.navn}</li>`;
        });
      }
    })
    .catch(error => { console.error("Fejl ved hentning af bookinger:", error); });
}
setInterval(hentBookinger, 10000);
window.onload = function() {
  hentBookinger();
  const popup = document.getElementById('popup-besked');
  if (popup) setTimeout(() => { popup.style.display = 'none'; }, 3000);
}
</script>
<footer>Â© Hornsberg Group</footer>
</body>
</html>