<!DOCTYPE html>
<html>
<head>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <title>Vasketider</title>
  <link rel="manifest" href="/static/manifest.json">
  <link rel="stylesheet" href="/static/style.css">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/service-worker.js');
    }
  </script>
</head>
<body>
  <div class="toppanel">
    <form method="post" action="/logout">
      <button class="toppanel-knap">Log ud</button>
    </form>
    <form method="get" action="/kommentar">
      <button class="toppanel-knap">Kommentar</button>
    </form>
    <form method="get" action="/dokumenter">
      <button class="toppanel-knap">Dokumenter</button>
    </form>
    <form method="get" action="/profil">
      <button class="toppanel-knap">Min profil</button>
    </form>
    <form method="get" action="/regler">
      <button class="toppanel-knap">Regler</button>
    </form>

    <div class="status">
      <span class="status-label">ðŸ§º Status:</span>
      <span class="status-value">{{ miele_status | capitalize }}</span>
    </div>

    <form method="get" action="/index" style="margin-left:auto; display:flex; gap:10px;">
      <button class="toppanel-knap" type="submit" name="uge" value="{{ valgt_uge - 1 }}">â—€</button>
      <span style="color:white; align-self: center;">Uge {{ valgt_uge }}</span>
      <button class="toppanel-knap" type="submit" name="uge" value="{{ valgt_uge + 1 }}">â–¶</button>
    </form>
  </div>

  <div class="wrapper">
    <banner><h2>Vasketider for TÃ¥singegade 16 â€“ Uge {{ valgt_uge }}</h2></banner>

    <div class="main">
      {% if request.args.get("besked") %}
        <div id="popup-besked" style="position: relative; padding: 10px; background-color: rgba(0,150,0,0.7); color: white; border-radius: 8px; font-weight: bold; margin-top: 10px; max-width: 300px;">
          {{ request.args.get("besked") }}
        </div>
      {% endif %}

      {% if request.args.get("fejl") %}
        <div id="popup-fejl" style="position: relative; padding: 10px; background-color: rgba(200,0,0,0.8); color: white; border-radius: 8px; font-weight: bold; margin-top: 10px; max-width: 300px;">
          {{ request.args.get("fejl") }}
        </div>
      {% endif %}

      <div class="calendar">
        <div></div>
        {% for dag in ugedage_dk %}
          {% set dato = ugedage_dato[loop.index0] %}
          <div style="text-align:center;">
            <strong>{{ dag }}</strong><br>d. {{ dato.day }}/{{ dato.month }}
          </div>
        {% endfor %}

        {% for i in range(4) %}
          <div><strong>{{ tider[i] }}</strong></div>
          {% for j in range(7) %}
            {% set dato = ugedage_dato[j] %}
            {% set cell = bookinger.get((dato, i)) %}
<div style="display:flex;justify-content:center;align-items:center;min-height:42px;">

  {# 1) FULD BOOKET? #}
  {% if cell and cell.full %}
  {% set f = cell.full %}

  {% if f.navn if f and f.navn else '' == 'service' %}
    <!-- Service = GUL (styres af .slot-btn.service i CSS) -->
    <button class="slot-btn service" disabled>
      Service
      <!--{% if f.status == 'pending_activation' %} Â· venter aktivering{% endif %}-->
    </button>

  {% elif f.navn if f and f.navn else '' == bruger %}
    <!-- Egen fuld booking = kan aflyses -->
    <form method="POST" action="/slet">
      <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
      <input type="hidden" name="tid" value="{{ i }}">
      <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
      <button type="submit" class="slot-btn" style="background-color:crimson;">
        <!--{{ f.navn }} (fuld){% if f.status == 'pending_activation' %} Â· venter aktivering{% endif %}-->
      </button>
    </form>

  {% else %}
    <!-- Anden bruger = rÃ¸d, disabled -->
    <button class="slot-btn" style="background-color:crimson;" disabled>
      <!--{{ f.navn }}{% if f.status == 'pending_activation' %} Â· venter aktivering{% endif %}-->
    </button>
  {% endif %}

  {% else %}
    {# 2) IKKE fuld â†’ vis Book-menu #}
    {% set has_early = cell and (cell.early is not none) %}
    {% set has_late  = cell and (cell.late  is not none) %}
    <details class="split-details {% if (cell and (cell.early and cell.early.navn=='service')) or (cell and (cell.late and cell.late.navn=='service')) %}service{% endif %}">
      <summary>Ledig</summary>
      <div class="split-panel">
        {# FULD (disabled hvis begge halvdele er taget) #}
        {% set fuld_disabled = has_early and has_late %}
        <form method="POST" action="/book">
          <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
          <input type="hidden" name="tid" value="{{ i }}">
          <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
          <button type="submit" class="menu-btn" {% if fuld_disabled %}disabled{% endif %}>
            Book fuld
          </button>
        </form>
        <hr class="menu-sep">

        {# TIDLIG #}
        <form method="POST" action="/book_half">
          <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
          <input type="hidden" name="tid" value="{{ i }}">
          <input type="hidden" name="sub" value="early">
          <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
          <button type="submit" class="menu-btn" {% if has_early %}disabled{% endif %}>
            Del tid: tidlig
          </button>
        </form>

        {# SEN #}
        <form method="POST" action="/book_half">
          <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
          <input type="hidden" name="tid" value="{{ i }}">
          <input type="hidden" name="sub" value="late">
          <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
          <button type="submit" class="menu-btn" {% if has_late %}disabled{% endif %}>
            Del tid: sen
          </button>
        </form>
      </div>
    </details>

    {# SmÃ¥ badge hvis man allerede har en halvdel #}
    {% if has_early and cell.early.navn == bruger %}
      <span class="slot-badge" style="margin-left:6px;background:crimson;color:#fff;border-radius:6px;padding:2px 6px;">Tidlig (min)</span>
    {% endif %}
    {% if has_late and cell.late.navn == bruger %}
      <span class="slot-badge" style="margin-left:6px;background:crimson;color:#fff;border-radius:6px;padding:2px 6px;">Sen (min)</span>
    {% endif %}
  {% endif %}
</div>
          {% endfor %}
        {% endfor %}
      </div>

      <hr>
      <h3>Alle bookede tider (nÃ¦ste 14 dage):</h3>
      <ul id="bookinger_14_ul">
        {% if kommende_bookinger %}
          {% for b in kommende_bookinger %}
            <li><strong>{{ b.dato_dk }}</strong> â€“ <strong>{{ b.slot_tekst }}</strong> â†’ {{ b.brugernavn }}</li>
          {% endfor %}
        {% else %}
          <li>Ingen bookede tider de nÃ¦ste 14 dage.</li>
        {% endif %}
      </ul>
    </div>
  </div>

  <script>
    function hentBookinger() {
      fetch('/bookinger_json')
        .then(res => { if (!res.ok) throw new Error("NetvÃ¦rksfejl: " + res.status); return res.json(); })
        .then(data => {
          let ul = document.getElementById('bookinger_14_ul');
          if (!ul) return;
          ul.innerHTML = "";
          if (data.length === 0) {
            ul.innerHTML = "<li>Ingen bookede tider de nÃ¦ste 14 dage.</li>";
          } else {
            data.forEach(function(item) {
              ul.innerHTML += `<li><strong>${item.dato}</strong> â€“ <strong>${item.tid}</strong> â†’ ${item.navn}</li>`;
            });
          }
        })
        .catch(error => { console.error("Fejl ved hentning af bookinger:", error); });
    }

    setInterval(hentBookinger, 10000);
    window.onload = function() {
      hentBookinger();
      const popupOK = document.getElementById('popup-besked');
      if (popupOK) setTimeout(() => { popupOK.style.display = 'none'; }, 3000);
      const popupErr = document.getElementById('popup-fejl');
      if (popupErr) setTimeout(() => { popupErr.style.display = 'none'; }, 4000);
    }
  </script>

  <footer>Â© Hornsberg Group</footer>
</body>
</html>