<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="utf-8">
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <title>Vasketider</title>
  <link rel="manifest" href="/static/manifest.json">
  <link rel="stylesheet" href="/static/style.css">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/service-worker.js');
    }
  </script>
</head>
<body>

  <!-- TOPBAR -->
  <header class="toppanel" role="banner">
    <!-- Venstre: Hamburger + brand -->
    <div class="top-left">
      <button class="hamburger" id="hamburger" type="button" aria-label="Åbn menu" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>
    </div>

    <!-- Center: Status -->
    <div class="top-center">
      <div class="status" id="miele-status" data-remaining="{{ miele_remaining or 0 }}">
        <span class="status-label">🧺 Status:</span>
        <span class="status-value">{{ (miele_status or 'ukendt')|capitalize }}</span>
        <span class="status-sep">•</span>
        <span class="status-eta" id="status-eta" style="display:none;"></span>
      </div>
    </div>

    <!-- Højre: Ugevælger -->
    <div class="top-right">
      <form method="get" action="/index" class="week-switch" aria-label="Ugevælger">
        <button class="toppanel-knap" type="submit" name="uge" value="{{ valgt_uge - 1 }}" aria-label="Forrige uge">◀</button>
        <span class="week-label">Uge {{ valgt_uge }}</span>
        <button class="toppanel-knap" type="submit" name="uge" value="{{ valgt_uge + 1 }}" aria-label="Næste uge">▶</button>
      </form>
      <form method="post" action="/logout">
        <button class="toppanel-knap" type="submit" aria-label="Log ud">Log ud</button>
      </form>
    </div>
  </header>

  <!-- Skuffe-menu (venstre) -->
  <aside class="nav-drawer" id="navDrawer" aria-hidden="true">
    <nav class="nav-list" aria-label="Hovedmenu">
      <a href="/kommentar">Kommentar</a>
      <a href="/dokumenter">Dokumenter</a>
      <a href="/profil">Min profil</a>
      <a href="/regler">Regler</a>
    </nav>
  </aside>
  <div class="nav-scrim" id="navScrim" hidden></div>

  <!-- WRAPPER -->
  <main class="wrapper" role="main">
    <div class="main">
      <h2 class="page-title">Vasketider for Tåsingegade 16 – Uge {{ valgt_uge }}</h2>

      {% if request.args.get("besked") %}
        <div id="popup-besked" class="popup-ok">
          {{ request.args.get("besked") }}
        </div>
      {% endif %}

      {% if request.args.get("fejl") %}
        <div id="popup-fejl" class="popup-error">
          {{ request.args.get("fejl") }}
        </div>
      {% endif %}

      <!-- KALENDER -->
      <div class="calendar">
        <!-- tom celle i hjørnet -->
        <div></div>

        <!-- Ugedage -->
        {% for dag in ugedage_dk %}
          {% set dhead = ugedage_dato[loop.index0] %}
          <div class="cal-head">
            <span class="cal-head-dag"><strong>{{ dag }}</strong></span>
            <span class="cal-head-dato">d. {{ dhead.day }}/{{ dhead.month }}</span>
          </div>
        {% endfor %}

        <!-- Rækker for tidsrum -->
        {% for i in range(4) %}
          <div class="time-label"><strong>{{ tider[i] }}</strong></div>

          {% for j in range(7) %}
            {% set dato = ugedage_dato[j] %}
            {% set cell = bookinger.get((dato, i)) %}

            <div class="cell-inner">
              {# 1) Fuldt booket #}
              {% if cell and cell.full %}
                {% set f = cell.full %}
                {% if f and f.navn == 'service' %}
                  <button class="slot-btn service" disabled>Service</button>
                {% elif f and f.navn == bruger %}
                  <form method="POST" action="/slet">
                    <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                    <input type="hidden" name="tid" value="{{ i }}">
                    <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                    <button type="submit" class="slot-btn booked-own"> {{ f.navn }} (fuld) </button>
                  </form>
                {% else %}
                  <button class="slot-btn booked" disabled>{{ f.navn }}</button>
                {% endif %}

              {% else %}
                {# 2) Halvt booket? #}
                {% set has_early = cell and (cell.early is not none) %}
                {% set has_late  = cell and (cell.late  is not none) %}
                {% set both_taken = has_early and has_late %}

                {% if not both_taken %}
                  <details class="split-details {% if (cell and cell.early and cell.early.navn=='service') or (cell and cell.late and cell.late.navn=='service') %}service{% endif %}">
                    <summary>Ledig</summary>
                    <div class="split-panel">
                      {% set fuld_disabled = has_early and has_late %}
                      <form method="POST" action="/book">
                        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                        <input type="hidden" name="tid" value="{{ i }}">
                        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                        <button type="submit" class="menu-btn" {% if fuld_disabled %}disabled{% endif %}>Book fuld</button>
                      </form>

                      <hr class="menu-sep">

                      <!-- Tidlig halvdel -->
                      <form method="POST" action="/book_half">
                        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                        <input type="hidden" name="tid" value="{{ i }}">
                        <input type="hidden" name="sub" value="early">
                        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                        <button type="submit" class="menu-btn" {% if has_early %}disabled{% endif %}>Del tid: tidlig</button>
                      </form>

                      <!-- Sen halvdel -->
                      <form method="POST" action="/book_half">
                        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                        <input type="hidden" name="tid" value="{{ i }}">
                        <input type="hidden" name="sub" value="late">
                        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                        <button type="submit" class="menu-btn" {% if has_late %}disabled{% endif %}>Del tid: sen</button>
                      </form>
                    </div>
                  </details>
                {% endif %}

                <!-- 3) Split-knapper (vandret, lavere, farver) -->
                <div class="split-pair">
                  {% if has_early %}
                    {% set e = cell.early %}
                    {% if e and e.navn == 'service' %}
                      <button class="slot-btn service half" disabled>Service (tidlig)</button>
                    {% elif e and e.navn == bruger %}
                      <form method="POST" action="/slet">
                        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                        <input type="hidden" name="tid" value="{{ i }}">
                        <input type="hidden" name="sub" value="early">
                        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                        <button type="submit" class="slot-btn booked-own half">Tidlig</button>
                      </form>
                    {% elif e %}
                      <button class="slot-btn booked half" disabled>1 {{ e.navn }}</button>
                    {% endif %}
                  {% endif %}

                  {% if has_late %}
                    {% set l = cell.late %}
                    {% if l and l.navn == 'service' %}
                      <button class="slot-btn service half" disabled>Service (sen)</button>
                    {% elif l and l.navn == bruger %}
                      <form method="POST" action="/slet">
                        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                        <input type="hidden" name="tid" value="{{ i }}">
                        <input type="hidden" name="sub" value="late">
                        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                        <button type="submit" class="slot-btn booked-own half">Senere</button>
                      </form>
                    {% elif l %}
                      <button class="slot-btn booked half" disabled>2 {{ l.navn }}</button>
                    {% endif %}
                  {% endif %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        {% endfor %}
      </div>

      <hr class="section-div">

      <h3>Alle bookede tider (næste 14 dage):</h3>
      <ul id="bookinger_14_ul" class="bullet-list">
        {% if kommende_bookinger %}
          {% for b in kommende_bookinger %}
            <li><strong>{{ b.dato_dk }}</strong> – <strong>{{ b.slot_tekst }}</strong> → {{ b.brugernavn }}</li>
          {% endfor %}
        {% else %}
          <li>Ingen bookede tider de næste 14 dage.</li>
        {% endif %}
      </ul>
    </div>
  </main>

  <!-- SCRIPTS -->
  <script>
    // Hamburger/drawer
    const burger = document.getElementById('hamburger');
    const drawer = document.getElementById('navDrawer');
    const scrim  = document.getElementById('navScrim');
    if (burger && drawer && scrim){
      const toggle = () => {
        const open = !drawer.classList.contains('open');
        drawer.classList.toggle('open', open);
        scrim.classList.toggle('show', open);
        scrim.hidden = !open;
        burger.classList.toggle('is-open', open);
        burger.setAttribute('aria-expanded', open ? 'true' : 'false');
        drawer.setAttribute('aria-hidden', open ? 'false' : 'true');
      };
      burger.addEventListener('click', toggle);
      scrim.addEventListener('click', toggle);
    }

    // Liste med bookinger
    function hentBookinger() {
      fetch('/bookinger_json')
        .then(res => { if (!res.ok) throw new Error("Netværksfejl: " + res.status); return res.json(); })
        .then(data => {
          const ul = document.getElementById('bookinger_14_ul');
          if (!ul) return;
          ul.innerHTML = "";
          if (data.length === 0) {
            ul.innerHTML = "<li>Ingen bookede tider de næste 14 dage.</li>";
          } else {
            data.forEach(function(item) {
              ul.innerHTML += `<li><strong>${item.dato}</strong> – <strong>${item.tid}</strong> → ${item.navn}</li>`;
            });
          }
        })
        .catch(error => { console.error("Fejl ved hentning af bookinger:", error); });
    }

    // Miele ETA (simpel client-timer)
    function renderETA() {
      const box = document.getElementById('miele-status');
      const etaSpan = document.getElementById('status-eta');
      if (!box || !etaSpan) return;

      let mins = parseInt(box.dataset.remaining || '0', 10);
      if (!Number.isFinite(mins) || mins <= 0) {
        etaSpan.style.display = 'none';
        return;
      }
      const end = new Date(Date.now() + mins * 60000);
      const hh = String(end.getHours()).padStart(2, '0');
      const mm = String(end.getMinutes()).padStart(2, '0');
      etaSpan.textContent = `⏱ ~${mins} min (færdig ca. kl. ${hh}:${mm})`;
      etaSpan.style.display = '';
    }
    function tickETA() {
      const box = document.getElementById('miele-status');
      if (!box) return;
      let mins = parseInt(box.dataset.remaining || '0', 10);
      if (!Number.isFinite(mins) || mins <= 0) return;
      mins = Math.max(0, mins - 1);
      box.dataset.remaining = String(mins);
      renderETA();
    }

    setInterval(hentBookinger, 10000);
    window.onload = function() {
      hentBookinger();
      const popupOK = document.getElementById('popup-besked');
      if (popupOK) setTimeout(() => { popupOK.style.display = 'none'; }, 3000);
      const popupErr = document.getElementById('popup-fejl');
      if (popupErr) setTimeout(() => { popupErr.style.display = 'none'; }, 4000);
      renderETA();
      setInterval(tickETA, 60000);
    };
  </script>

  <footer>© Hornsberg Group</footer>
</body>
</html>