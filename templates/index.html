<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>Vasketider</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('{{ url_for("static", filename="service-worker.js") }}');
    }
  </script>
</head>
<body>

<header class="toppanel" role="banner">
    <div class="top-left">
      <button class="hamburger" id="indexHamburger" type="button"
              aria-label="Åbn menu" aria-controls="indexTopMenu" aria-expanded="false">
        <span class="hamburger-bar"></span>
        <span class="hamburger-bar"></span>
        <span class="hamburger-bar"></span>
      </button>
      <div class="brand"><a href="/index">Vasketider</a></div>
    </div>
    
      <div class="status status-center" id="miele-status" data-remaining="{{ miele_remaining or 0 }}">
        <span class="status-label">🧺 Status:</span>
        <span class="status-value">{{ (miele_status or 'ukendt')|capitalize }}</span>
        <span class="status-sep">•</span>
        <span class="status-eta" id="status-eta" style="display:none;"></span>
      </div>

    <div class="week-switch">
      <form method="get" action="/index">
        <button class="toppanel-knap" name="week" value="{{ prev_week }}">◀ Forrige</button>
        <button class="toppanel-knap" name="week" value="{{ next_week }}">Næste ▶</button>
      </form>
    </div>

    <nav class="topmenu" id="indexTopMenu" role="menu" aria-label="Hovedmenu">
      <form method="get" action="/kommentar"><button class="toppanel-knap" type="submit">Kommentar</button></form>
      <form method="get" action="/dokumenter"><button class="toppanel-knap" type="submit">Dokumenter</button></form>
      <form method="get" action="/profil"><button class="toppanel-knap" type="submit">Min profil</button></form>
      <form method="get" action="/regler"><button class="toppanel-knap" type="submit">Regler</button></form>
      <form method="post" action="/logout"><button class="toppanel-knap danger" type="submit">Log ud</button></form>
    </nav>
  </header>

  <main class="wrapper" role="main">
    <div class="main">
      <h2 class="page-title">Vasketider for Tåsingegade 16 – Uge {{ valgt_uge }}</h2>

      {% if request.args.get("besked") %}
        <div id="popup-besked" class="popup-ok">
          {{ request.args.get("besked") }}
        </div>
      {% endif %}

      {% if request.args.get("fejl") %}
        <div id="popup-fejl" class="popup-error">
          {{ request.args.get("fejl") }}
        </div>
      {% endif %}

      <div class="calendar">
        <div></div>

        {% for dag in ugedage_dk %}
          {% set dhead = ugedage_dato[loop.index0] %}
          <div class="cal-head">
            <span class="cal-head-dag"><strong>{{ dag }}</strong></span>
            <span class="cal-head-dato">d. {{ dhead.day }}/{{ dhead.month }}</span>
          </div>
        {% endfor %}

        {% for i in range(4) %}
          <div class="time-label"><strong>{{ tider[i] }}</strong></div>

          {% for j in range(7) %}
            {% set dato = ugedage_dato[j] %}
            {% set cell = bookinger.get((dato, i)) %}

            <div class="cell-inner">
              {# 1) Fuldt booket #}
              {% if cell and cell.full %}
                {% set f = cell.full %}
                {% if f and f.navn == 'service' %}
                  <button class="slot-btn service" disabled>Service</button>
                {% elif f and f.navn == bruger %}
                  <form method="POST" action="/slet">
                    <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                    <input type="hidden" name="tid" value="{{ i }}">
                    <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                    <button type="submit" class="slot-btn optaget">{{ f.navn }}</button>
                  </form>
                {% else %}
                  <button class="slot-btn optaget" disabled>{{ f.navn }}</button>
                {% endif %}

              {% else %}
                {# 2) Halvt booket? #}
                {% set has_early = cell and (cell.early is not none) %}
                {% set has_late  = cell and (cell.late  is not none) %}
                {% set both_taken = has_early and has_late %}

                {% if not both_taken %}
                  <details class="split-details {% if (cell and cell.early and cell.early.navn=='service') or (cell and cell.late and cell.late.navn=='service') %}service{% else %}ledig{% endif %}">
                    <summary>Ledig</summary>
                    <div class="split-panel">
                      {% set fuld_disabled = has_early and has_late %}
                      <form method="POST" action="/book">
                        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                        <input type="hidden" name="tid" value="{{ i }}">
                        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                        <button type="submit" class="menu-btn" {% if fuld_disabled %}disabled{% endif %}>Book fuld</button>
                      </form>

                      <hr class="menu-sep">

                      <form method="POST" action="/book_half">
                        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                        <input type="hidden" name="tid" value="{{ i }}">
                        <input type="hidden" name="sub" value="early">
                        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                        <button type="submit" class="menu-btn" {% if has_early %}disabled{% endif %}>Del tid: tidlig</button>
                      </form>

                      <form method="POST" action="/book_half">
                        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                        <input type="hidden" name="tid" value="{{ i }}">
                        <input type="hidden" name="sub" value="late">
                        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                        <button type="submit" class="menu-btn" {% if has_late %}disabled{% endif %}>Del tid: sen</button>
                      </form>
                    </div>
                  </details>
                {% endif %}

                <div class="split-pair">
                  {% if has_early %}
                    {% set e = cell.early %}
                    {% if e and e.navn == 'service' %}
                      <button class="slot-btn service half" disabled>Service (tidlig)</button>
                    {% elif e and e.navn == bruger %}
                      <form method="POST" action="/slet">
                        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                        <input type="hidden" name="tid" value="{{ i }}">
                        <input type="hidden" name="sub" value="early">
                        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                        <button type="submit" class="slot-btn optaget half">Tidlig</button>
                      </form>
                    {% elif e %}
                      <button class="slot-btn optaget half" disabled>1 {{ e.navn }}</button>
                    {% endif %}
                  {% endif %}

                  {% if has_late %}
                    {% set l = cell.late %}
                    {% if l and l.navn == 'service' %}
                      <button class="slot-btn service half" disabled>Service (sen)</button>
                    {% elif l and l.navn == bruger %}
                      <form method="POST" action="/slet">
                        <input type="hidden" name="dato" value="{{ dato.isoformat() }}">
                        <input type="hidden" name="tid" value="{{ i }}">
                        <input type="hidden" name="sub" value="late">
                        <input type="hidden" name="valgt_uge" value="{{ valgt_uge }}">
                        <button type="submit" class="slot-btn optaget half">Senere</button>
                      </form>
                    {% elif l %}
                      <button class="slot-btn optaget half" disabled>2 {{ l.navn }}</button>
                    {% endif %}
                  {% endif %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        {% endfor %}
      </div>

      <hr class="section-div">

      <h3>Alle bookede tider (næste 14 dage):</h3>
      <ul id="bookinger_14_ul" class="bullet-list">
        {% if kommende_bookinger %}
          {% for b in kommende_bookinger %}
            <li><strong>{{ b.dato_dk }}</strong> – <strong>{{ b.slot_tekst }}</strong> → {{ b.brugernavn }}</li>
          {% endfor %}
        {% else %}
          <li>Ingen bookede tider de næste 14 dage.</li>
        {% endif %}
      </ul>
    </div>
  </main>
  <script>
    function hentBookinger() {
      fetch('/bookinger_json')
        .then(res => { if (!res.ok) throw new Error("Netværksfejl: " + res.status); return res.json(); })
        .then(data => {
          const ul = document.getElementById('bookinger_14_ul');
          if (!ul) return;
          ul.innerHTML = "";
          if (data.length === 0) {
            ul.innerHTML = "<li>Ingen bookede tider de næste 14 dage.</li>";
          } else {
            data.forEach(function(item) {
              ul.innerHTML += `<li><strong>${item.dato}</strong> – <strong>${item.tid}</strong> → ${item.navn}</li>`;
            });
          }
        })
        .catch(error => { console.error("Fejl ved hentning af bookinger:", error); });
    }

    function renderETA() {
      const box = document.getElementById('miele-status');
      const etaSpan = document.getElementById('status-eta');
      if (!box || !etaSpan) return;

      let mins = parseInt(box.dataset.remaining || '0', 10);
      if (!Number.isFinite(mins) || mins <= 0) {
        etaSpan.style.display = 'none';
        return;
      }
      const end = new Date(Date.now() + mins * 60000);
      const hh = String(end.getHours()).padStart(2, '0');
      const mm = String(end.getMinutes()).padStart(2, '0');
      etaSpan.textContent = `⏱ ~${mins} min (færdig ca. kl. ${hh}:${mm})`;
      etaSpan.style.display = '';
    }
    function tickETA() {
      const box = document.getElementById('miele-status');
      if (!box) return;
      let mins = parseInt(box.dataset.remaining || '0', 10);
      if (!Number.isFinite(mins) || mins <= 0) return;
      mins = Math.max(0, mins - 1);
      box.dataset.remaining = String(mins);
      renderETA();
    }

    setInterval(hentBookinger, 10000);
    window.onload = function() {
      hentBookinger();
      const popupOK = document.getElementById('popup-besked');
      if (popupOK) setTimeout(() => { popupOK.style.display = 'none'; }, 3000);
      const popupErr = document.getElementById('popup-fejl');
      if (popupErr) setTimeout(() => { popupErr.style.display = 'none'; }, 4000);
      renderETA();
      setInterval(tickETA, 60000);
    };
  </script>
<script src="{{ url_for('static', filename='js/menu.js') }}"></script>
  <script>
    // ÉN ren initialisering – ingen andre “hamburger”-scripts
    window.VasketiderMenu.attach({
      button: '#indexHamburger',
      drawer: '#indexTopMenu',
      closeOnRouteChange: true
    });
  </script>
  <footer>© Hornsberg Group</footer>
</body>
</html>